FROM alpine:3.19

WORKDIR /app

# Instala ferramentas essenciais
RUN apk add --no-cache bash coreutils

# Copia os arquivos necessÃ¡rios
COPY scripts/ scripts/
COPY templates/ templates/
COPY config/ config/

# Garante permissÃµes
RUN chmod +x scripts/*.sh

# Script que detecta o modo de operaÃ§Ã£o
CMD echo 'ðŸš€ [Dockerfile] Container iniciado. Detectando modo de operaÃ§Ã£o...' && \
    if [[ -f "config/apps.conf" ]]; then \
      echo 'ðŸ“‹ [Dockerfile] Modo GitOps detectado - usando apps.conf' && \
      bash scripts/generate-gitops-sql.sh && \
      bash scripts/generate-servers-json.sh; \
    else \
      echo 'ðŸ”§ [Dockerfile] Modo local detectado - usando generate-local-sql.sh' && \
      bash scripts/generate-local-sql.sh; \
    fi && \
    echo 'âœ… [Dockerfile] ExecuÃ§Ã£o de scripts concluÃ­da com sucesso.'
